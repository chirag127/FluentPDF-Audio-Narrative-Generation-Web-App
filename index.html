<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakFlow - Portable AI Converter</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#059669',
                        dark: '#0f172a',
                        surface: '#1e293b'
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'Fira Code', 'monospace'] },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(51, 65, 85, 0.8); }
        /* Draggable Styles */
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; }
        .sortable-drag { cursor: grabbing; }
        .model-item { cursor: grab; }
        .model-item:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300 min-h-screen flex flex-col font-sans">

    <nav class="glass-panel sticky top-0 z-50 shadow-sm border-b border-slate-200 dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-primary/20">
                        <i class="fa-solid fa-user-astronaut"></i>
                    </div>
                    <div>
                        <span class="font-bold text-lg tracking-tight block leading-none">SpeakFlow</span>
                        <span class="text-[10px] font-mono text-slate-500 dark:text-slate-400 uppercase tracking-wide">Portable Accounts</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="themeToggle" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"><i class="fa-solid fa-moon dark:hidden"></i><i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i></button>
                    <button onclick="app.ui.openSettings()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 relative group">
                        <i class="fa-solid fa-sliders group-hover:rotate-180 transition-transform duration-500"></i>
                        <span id="settingsBadge" class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full hidden animate-pulse"></span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full grid grid-cols-1 lg:grid-cols-12 gap-8">

        <div class="lg:col-span-8 space-y-6">

            <div id="dropZone" class="glass-panel rounded-3xl p-12 border-2 border-dashed border-slate-300 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all cursor-pointer group text-center relative overflow-hidden">
                <input type="file" id="fileInput" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div class="relative z-20 transition-transform group-hover:scale-[1.02] duration-300">
                    <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary group-hover:bg-primary group-hover:text-white transition-colors">
                        <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Upload PDF</h3>
                    <p class="text-sm text-slate-500">Visual parsing • Unlimited Concurrency • Priority Queue</p>
                </div>
            </div>

            <div id="fileInfoPanel" class="hidden glass-panel rounded-2xl p-6 border-l-4 border-primary flex flex-col sm:flex-row items-center justify-between gap-4 animate-fade-in">
                <div class="flex items-center gap-4 w-full">
                    <div class="w-12 h-12 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-regular fa-file-pdf"></i></div>
                    <div class="flex-1 min-w-0">
                        <h4 id="fileName" class="font-bold truncate max-w-[200px]">doc.pdf</h4>
                        <p id="fileSize" class="text-xs text-slate-500 font-mono">0 MB</p>
                    </div>
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button onclick="app.core.clearFile()" class="p-3 text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-times"></i></button>
                    <button onclick="app.core.startProcessing()" id="processBtn" class="flex-1 bg-primary hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-bolt"></i> Convert
                    </button>
                </div>
            </div>

            <div id="progressPanel" class="hidden glass-panel rounded-3xl p-8 space-y-6">
                <div class="flex justify-between items-end">
                    <div>
                        <h3 class="font-bold text-lg">Processing</h3>
                        <p id="strategyStatus" class="text-xs text-slate-500 font-mono uppercase mt-1">Initializing...</p>
                    </div>
                    <span id="totalProgressText" class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-primary to-purple-500">0%</span>
                </div>
                <div class="bg-slate-50 dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-2">
                        <span>Grid Status</span>
                        <span id="concurrencyIndicator">1x Parallel</span>
                    </div>
                    <div id="batchContainer" class="grid grid-cols-12 gap-1.5 max-h-[150px] overflow-y-auto custom-scrollbar"></div>
                </div>
                <button onclick="location.reload()" class="text-red-500 text-xs font-bold hover:underline">CANCEL</button>
            </div>

            <div id="resultPanel" class="hidden glass-panel rounded-3xl p-10 text-center border-t-4 border-secondary">
                <div class="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Conversion Complete</h2>
                <div class="flex justify-center gap-4 mt-6">
                    <button onclick="app.core.downloadFinal()" class="bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> Download
                    </button>
                    <button onclick="location.reload()" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 py-3 px-6 rounded-xl font-semibold hover:bg-slate-50">New File</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-4 space-y-6">
            <div class="glass-panel rounded-2xl overflow-hidden flex flex-col h-[500px] shadow-sm">
                <div class="p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex justify-between items-center">
                    <span class="text-xs font-bold uppercase text-slate-500">Engine Logs</span>
                    <span id="activeProvider" class="text-[10px] font-mono bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded">IDLE</span>
                </div>
                <div id="logConsole" class="flex-1 overflow-y-auto bg-slate-950 p-4 font-mono text-[10px] space-y-2">
                    <div class="text-slate-500 italic">Ready...</div>
                </div>
            </div>
        </div>
    </main>

    <div id="cacheModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6 border border-slate-200 dark:border-slate-700">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-database"></i>
                </div>
                <h3 class="text-xl font-bold">File Found in Cache</h3>
                <p class="text-sm text-slate-500 mt-2">Load saved version or re-run API?</p>
                <p id="cacheDate" class="text-xs font-mono text-slate-400 mt-1"></p>
            </div>
            <div class="flex gap-3">
                <button onclick="app.core.processCache(false)" class="flex-1 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 text-slate-700 dark:text-slate-200 py-3 rounded-xl font-semibold text-sm">Re-Run</button>
                <button onclick="app.core.processCache(true)" class="flex-1 bg-primary hover:bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Load Saved</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="app.ui.closeSettings()"></div>
        <div id="settingsPanel" class="absolute inset-y-0 right-0 max-w-lg w-full bg-white dark:bg-slate-900 shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
            <div class="p-6 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                <h2 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-sliders text-primary"></i> Configuration</h2>
                <button onclick="app.ui.closeSettings()"><i class="fa-solid fa-times text-xl text-slate-400"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">

                <section class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800">
                    <h3 class="text-xs font-bold uppercase text-indigo-600 dark:text-indigo-400 tracking-widest mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-floppy-disk"></i> Backup & Restore
                    </h3>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 mb-3 leading-relaxed">
                        Since this is a serverless app, your settings live in your browser. Use these buttons to save your setup (API keys, Prompts, Order) to a file and move it to another device.
                    </p>
                    <div class="flex gap-3">
                        <button onclick="app.account.export()" class="flex-1 bg-white dark:bg-slate-800 border border-indigo-200 dark:border-indigo-700 text-indigo-600 dark:text-indigo-300 py-2 rounded-lg text-xs font-bold hover:bg-indigo-50 transition-colors">
                            <i class="fa-solid fa-download mr-1"></i> Export Config
                        </button>
                        <label class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg text-xs font-bold transition-colors cursor-pointer text-center flex items-center justify-center">
                            <i class="fa-solid fa-upload mr-1"></i> Import Config
                            <input type="file" class="hidden" accept=".json" onchange="app.account.import(this)">
                        </label>
                    </div>
                </section>

                <section class="space-y-4">
                    <h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest">API Credentials</h3>
                    <div class="grid gap-3">
                        <div class="relative">
                            <i class="fa-brands fa-google absolute left-3 top-2.5 text-slate-400"></i>
                            <input type="password" id="key_gemini" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg pl-9 pr-3 py-2 text-sm" placeholder="Gemini API Key">
                        </div>
                        <div class="relative">
                            <i class="fa-solid fa-bolt absolute left-3 top-2.5 text-slate-400"></i>
                            <input type="password" id="key_groq" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg pl-9 pr-3 py-2 text-sm" placeholder="Groq API Key">
                        </div>
                        <div class="relative">
                            <i class="fa-solid fa-brain absolute left-3 top-2.5 text-slate-400"></i>
                            <input type="password" id="key_cerebras" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg pl-9 pr-3 py-2 text-sm" placeholder="Cerebras API Key">
                        </div>
                    </div>
                </section>

                <hr class="border-slate-200 dark:border-slate-800">

                <section class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest">Model Priority Queue</h3>
                        <button onclick="app.ui.resetModelOrder()" class="text-[10px] text-primary hover:underline">Reset Order</button>
                    </div>
                    <p class="text-[10px] text-slate-500">Drag to reorder. The engine tries the top model first, then falls back downwards.</p>

                    <ul id="modelList" class="space-y-2 bg-slate-50 dark:bg-slate-800/50 p-2 rounded-xl border border-slate-200 dark:border-slate-700 max-h-[300px] overflow-y-auto custom-scrollbar">
                        </ul>
                </section>

                <hr class="border-slate-200 dark:border-slate-800">

                <section class="space-y-4">
                    <h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest">Performance</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold mb-1">Concurrency</label>
                            <input type="number" id="set_concurrency" min="1" value="1" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded p-2 text-sm">
                            <p class="text-[10px] text-slate-500 mt-1">Unlimited (Browser limits apply)</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1">Retry Delay (ms)</label>
                            <input type="number" id="set_retryDelay" value="2000" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded p-2 text-sm">
                        </div>
                    </div>
                </section>

                <hr class="border-slate-200 dark:border-slate-800">

                <section class="space-y-4">
                    <h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest">Prompt Engineering</h3>
                    <div>
                        <label class="block text-xs font-bold mb-1">System Instruction</label>
                        <textarea id="set_sysPrompt" rows="3" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-xs font-mono"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1">Transformation Rules</label>
                        <textarea id="set_rulesPrompt" rows="4" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-xs font-mono"></textarea>
                    </div>
                    <button onclick="app.ui.restorePrompts()" class="text-xs text-primary hover:underline">Restore Default Prompts</button>
                </section>
            </div>

            <div class="p-4 border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-950">
                <button onclick="app.ui.saveSettings()" class="w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-600 transition-colors">Save Configuration</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            state: { file: null, chunks: [], results: [], finalPDFBlob: null, finalPDFName: "" },
            config: {
                get: k => localStorage.getItem(`sf_${k}`),
                set: (k, v) => localStorage.setItem(`sf_${k}`, v),
                getJSON: k => JSON.parse(localStorage.getItem(`sf_${k}`) || "null")
            },

            defaults: {
                sys: "You are a specialized Accessibility Engine designed to convert technical PDF text into a fluid 'Spokable Script' for Text-to-Speech (TTS) systems. Your goal is to make the content intelligently listenable, ensuring clarity and comprehensive understanding.",
                rules: "1. OUTPUT FORMAT: Generate pure Markdown only. Do not include any conversational text or explanations outside the transformed content.\n2. NARRATIVE INTEGRITY: Preserve the original English narrative and meaning exactly. Do not summarize or alter the core text of valid sentences unless specified.\n3. IMAGES & LOGOS: If the input text includes mentions of figures (e.g., 'Figure 1', 'Logo'), infer from the surrounding text and verbally describe the visual content and its purpose (e.g., 'A diagram illustrating the system architecture,' 'The company logo, a stylized 'SpeakFlow' icon.'). If no context, state 'An image is present here, but its content is not described in the text.'\n4. TABLES: Convert tables into concise, easy-to-understand narrative sentences. Describe the relationship between columns and rows verbally (e.g., 'The first row shows that X is Y, the second row states A is B.'). Avoid simply listing cell values.\n5. CODE BLOCKS: Describe the function or logic of code blocks verbally. Do not read out individual syntax characters or complex code structures. Focus on 'what it does' rather than 'how it looks.'\n6. MATHEMATICAL EXPRESSIONS: Expand complex mathematical symbols or equations into spoken words where appropriate to ensure clarity for an audio listener (e.g., 'x squared plus y equals z' for 'x² + y = z'). For very long equations, provide a high-level description.\n7. CLEANLINESS: Remove all non-essential elements such as page numbers, document headers, footers, and redundant navigational text that would disrupt an audio flow.\n8. CONSISTENCY: Maintain a consistent, formal, and objective tone suitable for technical documentation."
            },

            // Raw Data for Models
            modelData: [
                // GEMINI
                { id: "gemini-2.5-flash-lite-preview-09-2025", name: "Gemini 2.5 Flash Lite", provider: "gemini" },
                { id: "gemini-2.5-flash-preview-09-2025", name: "Gemini 2.5 Flash", provider: "gemini" },
                { id: "gemini-2.5-pro", name: "Gemini 2.5 Pro", provider: "gemini" },
                { id: "gemini-3-pro-preview", name: "Gemini 3 Pro Preview", provider: "gemini" },
                // GROQ
                { id: "openai/gpt-oss-120b", name: "Groq: GPT-OSS-120B", provider: "groq" },
                { id: "llama-3.3-70b-versatile", name: "Groq: Llama 3.3 70B", provider: "groq" },
                { id: "llama-3.2-90b-text-preview", name: "Groq: Llama 3.2 90B", provider: "groq" },
                { id: "mixtral-8x7b-32768", name: "Groq: Mixtral 8x7b", provider: "groq" },
                { id: "llama-3.1-70b-versatile", name: "Groq: Llama 3.1 70B", provider: "groq" },
                { id: "gemma2-9b-it", name: "Groq: Gemma 2 9B", provider: "groq" },
                { id: "llama-3.1-8b-instant", name: "Groq: Llama 3.1 8B", provider: "groq" },
                // CEREBRAS
                { id: "llama-3.3-70b", name: "Cerebras: Llama 3.3 70B", provider: "cerebras" },
                { id: "gpt-oss-120b", name: "Cerebras: GPT-OSS-120B", provider: "cerebras" },
                { id: "qwen-3-235b-a22b-instruct-2507", name: "Cerebras: Qwen 3 235B", provider: "cerebras" },
                { id: "zai-glm-4.6", name: "Cerebras: Zai GLM 4.6", provider: "cerebras" },
                { id: "qwen-3-32b", name: "Cerebras: Qwen 3 32B", provider: "cerebras" },
                { id: "llama3.1-70b", name: "Cerebras: Llama 3.1 70B", provider: "cerebras" },
                { id: "llama3.1-8b", name: "Cerebras: Llama 3.1 8B", provider: "cerebras" }
            ],

            providers: {
                gemini: {
                    url: (m, k) => `https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${k}`,
                    headers: () => ({'Content-Type': 'application/json'}),
                    payload: (sys, rules, user) => ({ contents: [{ parts: [{ text: `${sys}\n\nRULES:\n${rules}\n\nINPUT:\n${user}` }] }] }),
                    extract: (d) => d.candidates?.[0]?.content?.parts?.[0]?.text
                },
                groq: {
                    url: () => `https://api.groq.com/openai/v1/chat/completions`,
                    headers: (k) => ({'Content-Type': 'application/json', 'Authorization': `Bearer ${k}`}),
                    payload: (sys, rules, user, m) => ({ model: m, messages: [{ role: "system", content: `${sys}\n${rules}` }, { role: "user", content: user }] }),
                    extract: (d) => d.choices?.[0]?.message?.content
                },
                cerebras: {
                    url: () => `https://api.cerebras.ai/v1/chat/completions`,
                    headers: (k) => ({'Content-Type': 'application/json', 'Authorization': `Bearer ${k}`}),
                    payload: (sys, rules, user, m) => ({ model: m, messages: [{ role: "system", content: `${sys}\n${rules}` }, { role: "user", content: user }] }),
                    extract: (d) => d.choices?.[0]?.message?.content
                }
            },

            db: {
                init: async () => idb.openDB('speakflow_v4', 1, { upgrade(db) { if (!db.objectStoreNames.contains('records')) db.createObjectStore('records', { keyPath: 'id' }); } }),
                save: async (file, blob) => {
                    const db = await app.db.init();
                    await db.put('records', { id: `${file.name}_${file.size}`, fileName: file.name, date: new Date(), outputBlob: blob });
                    app.ui.log('Saved to Local Cache', 'success');
                },
                check: async (file) => {
                    const db = await app.db.init();
                    return await db.get('records', `${file.name}_${file.size}`);
                }
            },

            account: {
                export: () => {
                    const data = {};
                    Object.keys(localStorage).forEach(k => {
                        if(k.startsWith('sf_')) data[k] = localStorage.getItem(k);
                    });
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'speakflow_config.json';
                    a.click();
                    app.ui.log('Configuration Exported', 'success');
                },
                import: (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                            app.ui.log('Configuration Imported', 'success');
                            setTimeout(() => location.reload(), 1000);
                        } catch(err) {
                            alert('Invalid Config File');
                        }
                    };
                    reader.readAsText(file);
                }
            },

            ui: {
                init: () => {
                    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
                    document.getElementById('themeToggle').addEventListener('click', () => document.documentElement.classList.toggle('dark'));

                    const drop = document.getElementById('dropZone');
                    drop.addEventListener('click', () => document.getElementById('fileInput').click());
                    document.getElementById('fileInput').addEventListener('change', (e) => app.core.handleFile(e.target.files[0]));
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(n => drop.addEventListener(n, (e) => {e.preventDefault(); e.stopPropagation()}));
                    drop.addEventListener('drop', (e) => app.core.handleFile(e.dataTransfer.files[0]));

                    app.ui.checkKeys();
                },
                checkKeys: () => {
                    const hasKey = ['key_gemini','key_groq','key_cerebras'].some(k => app.config.get(k));
                    document.getElementById('settingsBadge').classList.toggle('hidden', !!hasKey);
                },
                openSettings: () => {
                    document.getElementById('settingsModal').classList.remove('hidden');
                    setTimeout(() => document.getElementById('settingsPanel').classList.remove('translate-x-full'), 10);
                    ['key_gemini','key_groq','key_cerebras'].forEach(k => document.getElementById(k).value = app.config.get(k) || '');

                    document.getElementById('set_concurrency').value = app.config.get('set_concurrency') || 1;
                    document.getElementById('set_retryDelay').value = app.config.get('set_retryDelay') || 2000;
                    document.getElementById('set_sysPrompt').value = app.config.get('set_sysPrompt') || app.defaults.sys;
                    document.getElementById('set_rulesPrompt').value = app.config.get('set_rulesPrompt') || app.defaults.rules;

                    app.ui.renderModelList();
                },
                renderModelList: () => {
                    const list = document.getElementById('modelList');
                    list.innerHTML = '';

                    // Get stored order or default
                    let order = app.config.getJSON('modelOrder');
                    if (!order || order.length === 0) {
                        order = app.modelData.map(m => m.id); // Default: List all
                    } else {
                         // Merge in any new models not in stored order
                        const existingIds = new Set(order);
                        app.modelData.forEach(m => { if(!existingIds.has(m.id)) order.push(m.id); });
                    }

                    order.forEach(id => {
                        const model = app.modelData.find(m => m.id === id);
                        if(!model) return;

                        const li = document.createElement('li');
                        li.className = 'model-item bg-white dark:bg-slate-900 p-2 rounded-lg flex items-center justify-between text-xs border border-slate-100 dark:border-slate-700 shadow-sm';
                        li.dataset.id = model.id;

                        let badgeClass = "bg-gray-100 text-gray-600";
                        if(model.provider === 'gemini') badgeClass = "bg-blue-100 text-blue-600";
                        if(model.provider === 'groq') badgeClass = "bg-orange-100 text-orange-600";
                        if(model.provider === 'cerebras') badgeClass = "bg-pink-100 text-pink-600";

                        li.innerHTML = `
                            <div class="flex items-center gap-3">
                                <span class="cursor-grab text-slate-400 hover:text-slate-600"><i class="fa-solid fa-grip-vertical"></i></span>
                                <span class="font-medium">${model.name}</span>
                            </div>
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${badgeClass}">${model.provider}</span>
                        `;
                        list.appendChild(li);
                    });

                    // Init Sortable for Drag and Drop
                    new Sortable(list, { animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag' });
                },
                resetModelOrder: () => {
                    localStorage.removeItem(`sf_modelOrder`);
                    app.ui.renderModelList();
                },
                closeSettings: () => {
                    document.getElementById('settingsPanel').classList.add('translate-x-full');
                    setTimeout(() => document.getElementById('settingsModal').classList.add('hidden'), 300);
                },
                restorePrompts: () => {
                    document.getElementById('set_sysPrompt').value = app.defaults.sys;
                    document.getElementById('set_rulesPrompt').value = app.defaults.rules;
                },
                saveSettings: () => {
                    ['key_gemini','key_groq','key_cerebras'].forEach(k => app.config.set(k, document.getElementById(k).value.trim()));
                    app.config.set('set_concurrency', document.getElementById('set_concurrency').value);
                    app.config.set('set_retryDelay', document.getElementById('set_retryDelay').value);
                    app.config.set('set_sysPrompt', document.getElementById('set_sysPrompt').value);
                    app.config.set('set_rulesPrompt', document.getElementById('set_rulesPrompt').value);

                    // Save List Order from DOM
                    const list = document.getElementById('modelList');
                    const order = Array.from(list.children).map(li => li.dataset.id);
                    localStorage.setItem('sf_modelOrder', JSON.stringify(order));

                    app.ui.closeSettings();
                    app.ui.checkKeys();
                    app.ui.log("Configuration Saved", "success");
                },
                log: (msg, type) => {
                    const el = document.getElementById('logConsole');
                    const div = document.createElement('div');
                    div.className = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : 'text-slate-400';
                    div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                    el.appendChild(div);
                    el.scrollTop = el.scrollHeight;
                },
                updateBatch: (i, status) => {
                    const el = document.getElementById(`batch-${i}`);
                    if (el) el.className = `h-2 w-full rounded-full transition-all ${status==='processing'?'bg-yellow-400 animate-pulse':status==='success'?'bg-green-500':status==='error'?'bg-red-500':'bg-slate-200'}`;
                }
            },

            core: {
                handleFile: async (f) => {
                    if (!f || f.type !== 'application/pdf') return alert('PDF Only');
                    app.state.file = f;
                    const cached = await app.db.check(f);
                    if(cached) {
                        document.getElementById('cacheDate').textContent = `Saved: ${cached.date.toLocaleString()}`;
                        document.getElementById('cacheModal').classList.remove('hidden');
                        app.state.cachedRecord = cached;
                        return;
                    }
                    app.core.loadUI(f);
                },
                processCache: (useCache) => {
                    document.getElementById('cacheModal').classList.add('hidden');
                    if(useCache) {
                        app.state.finalPDFBlob = app.state.cachedRecord.outputBlob;
                        app.state.finalPDFName = app.state.cachedRecord.fileName;
                        document.getElementById('dropZone').classList.add('hidden');
                        document.getElementById('resultPanel').classList.remove('hidden');
                        app.ui.log('Loaded from Cache', 'success');
                    } else {
                        app.core.loadUI(app.state.file);
                    }
                },
                loadUI: (f) => {
                    document.getElementById('dropZone').classList.add('hidden');
                    document.getElementById('fileInfoPanel').classList.remove('hidden');
                    document.getElementById('fileName').textContent = f.name;
                    document.getElementById('fileSize').textContent = (f.size/1024/1024).toFixed(2) + " MB";
                },
                clearFile: () => location.reload(),
                startProcessing: async () => {
                    if (!['key_gemini','key_groq','key_cerebras'].some(k => app.config.get(k))) return app.ui.openSettings();

                    document.getElementById('fileInfoPanel').classList.add('hidden');
                    document.getElementById('progressPanel').classList.remove('hidden');

                    // Unlimited Concurrency Setting
                    const concurrency = parseInt(app.config.get('set_concurrency') || 1);
                    document.getElementById('concurrencyIndicator').innerText = `${concurrency}x Parallel`;

                    app.ui.log('Parsing PDF...');
                    const text = await app.core.extractText(app.state.file);

                    // Chunk size approx 15k chars
                    app.state.chunks = app.core.chunk(text, 15000);

                    const container = document.getElementById('batchContainer');
                    container.innerHTML = '';
                    app.state.chunks.forEach((_, i) => {
                        const d = document.createElement('div');
                        d.id = `batch-${i}`; d.className = 'h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full';
                        container.appendChild(d);
                    });

                    app.state.results = new Array(app.state.chunks.length);

                    // Parallel Processing Pool
                    let index = 0;
                    const processNext = async () => {
                        if (index >= app.state.chunks.length) return;
                        const i = index++;
                        try {
                            await app.engine.process(app.state.chunks[i], i);
                            document.getElementById('totalProgressText').textContent = Math.round(((i+1)/app.state.chunks.length)*100) + '%';
                        } catch(e) { console.error(e); }
                        await processNext();
                    };

                    const pool = [];
                    for(let k=0; k<concurrency; k++) pool.push(processNext());
                    await Promise.all(pool);

                    app.core.finish();
                },
                extractText: async (f) => {
                    const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
                    let txt = "";
                    for(let i=1; i<=pdf.numPages; i++) txt += (await (await pdf.getPage(i)).getTextContent()).items.map(x=>x.str).join(' ') + "\n\n";
                    return txt;
                },
                chunk: (t, s) => {
                    const chunks = []; let cur = "";
                    t.split('\n').forEach(l => { if(cur.length + l.length > s) { chunks.push(cur); cur = l + "\n"; } else cur += l + "\n"; });
                    if(cur) chunks.push(cur);
                    return chunks;
                },
                finish: async () => {
                    const doc = new window.jspdf.jsPDF();

                    // Robust PDF Generation to prevent overlap
                    app.state.results.forEach(res => {
                        if(res) app.core.renderMarkdownToPdf(doc, res);
                    });

                    const pdfBlob = doc.output('blob');
                    app.state.finalPDFBlob = pdfBlob;
                    app.state.finalPDFName = app.state.file.name;

                    await app.db.save(app.state.file, pdfBlob);

                    document.getElementById('progressPanel').classList.add('hidden');
                    document.getElementById('resultPanel').classList.remove('hidden');
                },
                renderMarkdownToPdf: (doc, markdownText) => {
                    const tokens = marked.lexer(markdownText);
                    let y = 20;
                    const pageHeight = 280; // A4 height approx
                    const margin = 20;
                    const maxWidth = 170;

                    // Helper to add text with overlap protection
                    const addText = (text, fontSize, fontStyle, isHeading = false) => {
                        doc.setFontSize(fontSize);
                        doc.setFont("times", fontStyle);

                        // Line height calculation based on font size
                        const lineHeight = fontSize * 0.5;

                        // Clean markdown symbols for the PDF output
                        const cleanText = text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/#/g, '').replace(/`/g, '');

                        const lines = doc.splitTextToSize(cleanText, maxWidth);

                        lines.forEach(line => {
                            // Check for page overflow BEFORE writing
                            if (y + lineHeight > pageHeight) {
                                doc.addPage();
                                y = margin;
                            }

                            doc.text(line, margin, y);
                            y += lineHeight; // Move down
                        });

                        // Add spacing after block
                        y += (fontSize * 0.3);
                    };

                    tokens.forEach(token => {
                        if (token.type === 'heading') {
                            // Add extra space before heading if not at top
                            if (y > margin + 10) y += 5;
                            addText(token.text, 16, 'bold', true);
                        }
                        else if (token.type === 'paragraph') {
                            addText(token.text, 12, 'normal');
                        }
                        else if (token.type === 'list') {
                            token.items.forEach(item => addText("• " + item.text, 12, 'normal'));
                        }
                        else if (token.type === 'code') {
                            addText(token.text, 11, 'italic');
                        }
                        else if (token.type === 'space') {
                            y += 2;
                        }
                    });
                },
                downloadFinal: () => {
                    if(app.state.finalPDFBlob) {
                        const url = URL.createObjectURL(app.state.finalPDFBlob);
                        const a = document.createElement('a');
                        a.href = url; a.download = `spokable_${app.state.finalPDFName}`;
                        document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    }
                }
            },

            engine: {
                process: async (text, idx) => {
                    app.ui.updateBatch(idx, 'processing');
                    const sys = app.config.get('set_sysPrompt') || app.defaults.sys;
                    const rules = app.config.get('set_rulesPrompt') || app.defaults.rules;

                    // 1. GET PRIORITY ORDER (From Drag & Drop Settings)
                    let order = app.config.getJSON('modelOrder');
                    if (!order || order.length === 0) order = app.modelData.map(m => m.id);

                    // 2. BUILD ATTEMPT LIST
                    let attempts = [];
                    order.forEach(modelId => {
                        const modelDef = app.modelData.find(m => m.id === modelId);
                        if (modelDef) {
                            const key = app.config.get(`key_${modelDef.provider}`);
                            if (key) attempts.push({ p: modelDef.provider, m: modelDef.id, k: key });
                        }
                    });

                    if (attempts.length === 0) {
                        app.ui.updateBatch(idx, 'error');
                        app.state.results[idx] = "[ERROR: No API Keys Configured]";
                        return;
                    }

                    // 3. EXECUTE
                    for(const att of attempts) {
                        try {
                            if(att !== attempts[0]) app.ui.updateBatch(idx, 'fallback');
                            document.getElementById('activeProvider').textContent = `${att.p}: ${att.m}`;

                            const pd = app.providers[att.p];
                            const res = await fetch(pd.url(att.m, att.k), {
                                method: 'POST', headers: pd.headers(att.k), body: JSON.stringify(pd.payload(sys, rules, text, att.m))
                            });

                            if(!res.ok) {
                                if([429, 503].includes(res.status)) {
                                    // Rate limit: wait a bit then try NEXT model
                                    await new Promise(r=>setTimeout(r, 1000));
                                    continue;
                                }
                                throw new Error(res.status);
                            }

                            const data = await res.json();
                            const out = pd.extract(data);
                            if(!out) throw new Error("Empty");

                            app.state.results[idx] = out;
                            app.ui.updateBatch(idx, 'success');
                            app.ui.log(`Batch ${idx+1} OK via ${att.m}`, 'success');
                            return;
                        } catch(e) { /* Try next model in list */ }
                    }
                    app.ui.updateBatch(idx, 'error');
                    app.state.results[idx] = "[FAILED]";
                }
            }
        };
        window.addEventListener('DOMContentLoaded', app.ui.init);
    </script>
</body>
</html>