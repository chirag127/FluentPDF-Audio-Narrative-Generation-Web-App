<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakFlow - Universal AI PDF Converter</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5', // Indigo 600
                        secondary: '#059669', // Emerald 600
                        dark: '#0f172a', // Slate 950
                        surface: '#1e293b' // Slate 800
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'Fira Code', 'monospace'] },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(51, 65, 85, 0.8); }
        select, textarea, input { transition: all 0.2s; }
        select:focus, textarea:focus, input:focus { ring: 2px; ring-color: #4f46e5; border-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300 min-h-screen flex flex-col font-sans">

    <nav class="glass-panel sticky top-0 z-50 shadow-sm border-b border-slate-200 dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-primary/20">
                        <i class="fa-solid fa-universal-access"></i>
                    </div>
                    <div>
                        <span class="font-bold text-lg tracking-tight block leading-none">SpeakFlow</span>
                        <span class="text-[10px] font-mono text-slate-500 dark:text-slate-400 uppercase tracking-wide">Universal Converter</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="themeToggle" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"><i class="fa-solid fa-moon dark:hidden"></i><i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i></button>
                    <button onclick="app.ui.openSettings()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 relative group">
                        <i class="fa-solid fa-sliders group-hover:rotate-180 transition-transform duration-500"></i>
                        <span id="settingsBadge" class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full hidden animate-pulse"></span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full grid grid-cols-1 lg:grid-cols-12 gap-8">

        <div class="lg:col-span-8 space-y-6">

            <div id="dropZone" class="glass-panel rounded-3xl p-12 border-2 border-dashed border-slate-300 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all cursor-pointer group text-center relative overflow-hidden">
                <input type="file" id="fileInput" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div class="relative z-20 transition-transform group-hover:scale-[1.02] duration-300">
                    <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary group-hover:bg-primary group-hover:text-white transition-colors">
                        <i class="fa-solid fa-file-audio text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Upload PDF</h3>
                    <p class="text-sm text-slate-500">Local Cache • Visual AI Parsing • TTS Optimized</p>
                </div>
            </div>

            <div id="fileInfoPanel" class="hidden glass-panel rounded-2xl p-6 border-l-4 border-primary flex flex-col sm:flex-row items-center justify-between gap-4 animate-fade-in">
                <div class="flex items-center gap-4 w-full">
                    <div class="w-12 h-12 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-regular fa-file-pdf"></i></div>
                    <div class="flex-1 min-w-0">
                        <h4 id="fileName" class="font-bold truncate max-w-[200px]">doc.pdf</h4>
                        <p id="fileSize" class="text-xs text-slate-500 font-mono">0 MB</p>
                    </div>
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button onclick="app.core.clearFile()" class="p-3 text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-times"></i></button>
                    <button onclick="app.core.startProcessing()" id="processBtn" class="flex-1 bg-primary hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-bolt"></i> Convert
                    </button>
                </div>
            </div>

            <div id="progressPanel" class="hidden glass-panel rounded-3xl p-8 space-y-6">
                <div class="flex justify-between items-end">
                    <div>
                        <h3 class="font-bold text-lg">Generating Audio Script</h3>
                        <p id="strategyStatus" class="text-xs text-slate-500 font-mono uppercase mt-1">Initializing...</p>
                    </div>
                    <span id="totalProgressText" class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-primary to-purple-500">0%</span>
                </div>
                <div class="bg-slate-50 dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between text-[10px] uppercase font-bold text-slate-400 mb-2">
                        <span>Processing Grid</span>
                        <span id="concurrencyIndicator">1x Parallel</span>
                    </div>
                    <div id="batchContainer" class="grid grid-cols-12 gap-1.5 max-h-[150px] overflow-y-auto custom-scrollbar"></div>
                </div>
                <button onclick="location.reload()" class="text-red-500 text-xs font-bold hover:underline">CANCEL</button>
            </div>

            <div id="resultPanel" class="hidden glass-panel rounded-3xl p-10 text-center border-t-4 border-secondary">
                <div class="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                    <i class="fa-solid fa-headphones"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Conversion Complete</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-8 text-sm">Clean, spoken-English PDF ready for download.</p>
                <div class="flex justify-center gap-4">
                    <button onclick="app.core.downloadFinal()" class="bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> Download
                    </button>
                    <button onclick="location.reload()" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 py-3 px-6 rounded-xl font-semibold hover:bg-slate-50">Process New</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-4 space-y-6">
            <div class="glass-panel rounded-2xl overflow-hidden flex flex-col h-[500px] shadow-sm">
                <div class="p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex justify-between items-center">
                    <span class="text-xs font-bold uppercase text-slate-500">Engine Feed</span>
                    <span id="activeProvider" class="text-[10px] font-mono bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded">IDLE</span>
                </div>
                <div id="logConsole" class="flex-1 overflow-y-auto bg-slate-950 p-4 font-mono text-[10px] space-y-2">
                    <div class="text-slate-500 italic">System ready...</div>
                </div>
            </div>
        </div>
    </main>

    <div id="cacheModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6 border border-slate-200 dark:border-slate-700">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-database"></i>
                </div>
                <h3 class="text-xl font-bold">File Found in Cache</h3>
                <p class="text-sm text-slate-500 mt-2">Load instant version or use API to re-convert?</p>
                <p id="cacheDate" class="text-xs font-mono text-slate-400 mt-1"></p>
            </div>
            <div class="flex gap-3">
                <button onclick="app.core.processCache(false)" class="flex-1 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 text-slate-700 dark:text-slate-200 py-3 rounded-xl font-semibold text-sm">Re-Convert</button>
                <button onclick="app.core.processCache(true)" class="flex-1 bg-primary hover:bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Load Cached</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="app.ui.closeSettings()"></div>
        <div id="settingsPanel" class="absolute inset-y-0 right-0 max-w-lg w-full bg-white dark:bg-slate-900 shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
            <div class="p-6 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                <h2 class="text-lg font-bold flex items-center gap-2"><i class="fa-solid fa-sliders text-primary"></i> Engine Config</h2>
                <button onclick="app.ui.closeSettings()"><i class="fa-solid fa-times text-xl text-slate-400"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">

                <section class="space-y-4">
                    <h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest">Provider & Model Priority</h3>

                    <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="block text-sm font-bold mb-2 flex items-center gap-2"><i class="fa-brands fa-google"></i> Gemini API</label>
                        <input type="password" id="key_gemini" class="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm mb-2" placeholder="Key">
                        <label class="text-[10px] font-bold uppercase text-slate-500">Default Model</label>
                        <select id="pref_gemini_model" class="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-xs font-mono"></select>
                    </div>

                    <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="block text-sm font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-bolt text-orange-500"></i> Groq API</label>
                        <input type="password" id="key_groq" class="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm mb-2" placeholder="Key">
                        <label class="text-[10px] font-bold uppercase text-slate-500">Default Model</label>
                        <select id="pref_groq_model" class="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-xs font-mono"></select>
                    </div>

                    <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700">
                        <label class="block text-sm font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-brain text-pink-500"></i> Cerebras API</label>
                        <input type="password" id="key_cerebras" class="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm mb-2" placeholder="Key">
                        <label class="text-[10px] font-bold uppercase text-slate-500">Default Model</label>
                        <select id="pref_cerebras_model" class="w-full bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-xs font-mono"></select>
                    </div>
                </section>

                <hr class="border-slate-200 dark:border-slate-800">

                <section class="space-y-4">
                    <h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest">Performance</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold mb-1">Concurrency (1-10)</label>
                            <input type="number" id="set_concurrency" min="1" max="10" value="1" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold mb-1">Retry Delay (ms)</label>
                            <input type="number" id="set_retryDelay" value="2000" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded p-2 text-sm">
                        </div>
                    </div>
                </section>

                <hr class="border-slate-200 dark:border-slate-800">

                <section class="space-y-4">
                    <h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest">Prompt Engineering</h3>
                    <div>
                        <label class="block text-xs font-bold mb-1">System Instruction</label>
                        <textarea id="set_sysPrompt" rows="3" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-xs font-mono"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1">Transformation Rules</label>
                        <textarea id="set_rulesPrompt" rows="4" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg p-3 text-xs font-mono"></textarea>
                    </div>
                    <button onclick="app.ui.restorePrompts()" class="text-xs text-primary hover:underline">Restore Default Prompts</button>
                </section>
            </div>

            <div class="p-4 border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-950">
                <button onclick="app.ui.saveSettings()" class="w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-600 transition-colors">Save Configuration</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            state: { file: null, chunks: [], results: [], finalPDFBlob: null },
            config: { get: k => localStorage.getItem(`sf_${k}`), set: (k, v) => localStorage.setItem(`sf_${k}`, v) },

            defaults: {
                sys: "You are a specialized Accessibility Engine designed to convert technical PDF text into a fluid 'Spokable Script' for Text-to-Speech readers.",
                rules: "1. OUTPUT: Pure Markdown only.\n2. NARRATIVE: Keep English text exactly as is. Do not summarize valid sentences.\n3. IMAGES/LOGOS: If text contains captions like 'Figure 1', describe the visual context verbally (e.g. 'A chart showing sales trends').\n4. TABLES: Convert rows/columns into narrative sentences (e.g. 'Row 1 shows X is Y').\n5. CODE: Describe logic verbally; do not read syntax characters.\n6. CLEAN: Remove headers, footers, and page numbers."
            },

            // === MODEL ROSTERS ===
            models: {
                gemini: [
                    "gemini-2.5-flash-lite-preview-09-2025",
                    "gemini-2.5-flash-preview-09-2025",
                    "gemini-2.5-pro",
                    "gemini-3-pro-preview"
                ],
                groq: [
                    "openai/gpt-oss-120b", // NEW
                    "llama-3.3-70b-versatile",
                    "llama-3.2-90b-text-preview",
                    "mixtral-8x7b-32768",
                    "llama-3.1-70b-versatile",
                    "gemma2-9b-it",
                    "llama-3.1-8b-instant"
                ],
                cerebras: [
                    "llama-3.3-70b",
                    "gpt-oss-120b", // NEW
                    "qwen-3-235b-a22b-instruct-2507", // NEW
                    "zai-glm-4.6", // NEW
                    "qwen-3-32b", // NEW
                    "llama3.1-70b",
                    "llama3.1-8b"
                ]
            },

            providers: {
                gemini: {
                    url: (m, k) => `https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${k}`,
                    headers: () => ({'Content-Type': 'application/json'}),
                    payload: (sys, rules, user) => ({ contents: [{ parts: [{ text: `${sys}\n\nRULES:\n${rules}\n\nINPUT:\n${user}` }] }] }),
                    extract: (d) => d.candidates?.[0]?.content?.parts?.[0]?.text
                },
                groq: {
                    url: () => `https://api.groq.com/openai/v1/chat/completions`,
                    headers: (k) => ({'Content-Type': 'application/json', 'Authorization': `Bearer ${k}`}),
                    payload: (sys, rules, user, m) => ({ model: m, messages: [{ role: "system", content: `${sys}\n${rules}` }, { role: "user", content: user }] }),
                    extract: (d) => d.choices?.[0]?.message?.content
                },
                cerebras: {
                    url: () => `https://api.cerebras.ai/v1/chat/completions`,
                    headers: (k) => ({'Content-Type': 'application/json', 'Authorization': `Bearer ${k}`}),
                    payload: (sys, rules, user, m) => ({ model: m, messages: [{ role: "system", content: `${sys}\n${rules}` }, { role: "user", content: user }] }),
                    extract: (d) => d.choices?.[0]?.message?.content
                }
            },

            db: {
                init: async () => idb.openDB('speakflow_v3', 1, { upgrade(db) { if (!db.objectStoreNames.contains('records')) db.createObjectStore('records', { keyPath: 'id' }); } }),
                save: async (file, blob) => {
                    const db = await app.db.init();
                    await db.put('records', { id: `${file.name}_${file.size}`, fileName: file.name, date: new Date(), outputBlob: blob });
                    app.ui.log('Saved to Local Cache', 'success');
                },
                check: async (file) => {
                    const db = await app.db.init();
                    return await db.get('records', `${file.name}_${file.size}`);
                }
            },

            ui: {
                init: () => {
                    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
                    document.getElementById('themeToggle').addEventListener('click', () => document.documentElement.classList.toggle('dark'));

                    const drop = document.getElementById('dropZone');
                    drop.addEventListener('click', () => document.getElementById('fileInput').click());
                    document.getElementById('fileInput').addEventListener('change', (e) => app.core.handleFile(e.target.files[0]));
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(n => drop.addEventListener(n, (e) => {e.preventDefault(); e.stopPropagation()}));
                    drop.addEventListener('drop', (e) => app.core.handleFile(e.dataTransfer.files[0]));

                    app.ui.populateSelects();
                    app.ui.checkKeys();
                },
                populateSelects: () => {
                    const fill = (id, arr) => {
                        const el = document.getElementById(id); el.innerHTML = '';
                        arr.forEach(m => { const op = document.createElement('option'); op.value = m; op.text = m; el.appendChild(op); });
                    };
                    fill('pref_gemini_model', app.models.gemini);
                    fill('pref_groq_model', app.models.groq);
                    fill('pref_cerebras_model', app.models.cerebras);
                },
                checkKeys: () => {
                    const hasKey = ['key_gemini','key_groq','key_cerebras'].some(k => app.config.get(k));
                    document.getElementById('settingsBadge').classList.toggle('hidden', !!hasKey);
                },
                openSettings: () => {
                    document.getElementById('settingsModal').classList.remove('hidden');
                    setTimeout(() => document.getElementById('settingsPanel').classList.remove('translate-x-full'), 10);

                    ['key_gemini','key_groq','key_cerebras'].forEach(k => document.getElementById(k).value = app.config.get(k) || '');

                    // Restore Model Preferences
                    if(app.config.get('pref_gemini_model')) document.getElementById('pref_gemini_model').value = app.config.get('pref_gemini_model');
                    if(app.config.get('pref_groq_model')) document.getElementById('pref_groq_model').value = app.config.get('pref_groq_model');
                    if(app.config.get('pref_cerebras_model')) document.getElementById('pref_cerebras_model').value = app.config.get('pref_cerebras_model');

                    document.getElementById('set_concurrency').value = app.config.get('set_concurrency') || 1;
                    document.getElementById('set_retryDelay').value = app.config.get('set_retryDelay') || 2000;
                    document.getElementById('set_sysPrompt').value = app.config.get('set_sysPrompt') || app.defaults.sys;
                    document.getElementById('set_rulesPrompt').value = app.config.get('set_rulesPrompt') || app.defaults.rules;
                },
                closeSettings: () => {
                    document.getElementById('settingsPanel').classList.add('translate-x-full');
                    setTimeout(() => document.getElementById('settingsModal').classList.add('hidden'), 300);
                },
                restorePrompts: () => {
                    document.getElementById('set_sysPrompt').value = app.defaults.sys;
                    document.getElementById('set_rulesPrompt').value = app.defaults.rules;
                },
                saveSettings: () => {
                    ['key_gemini','key_groq','key_cerebras'].forEach(k => app.config.set(k, document.getElementById(k).value.trim()));

                    app.config.set('pref_gemini_model', document.getElementById('pref_gemini_model').value);
                    app.config.set('pref_groq_model', document.getElementById('pref_groq_model').value);
                    app.config.set('pref_cerebras_model', document.getElementById('pref_cerebras_model').value);

                    app.config.set('set_concurrency', document.getElementById('set_concurrency').value);
                    app.config.set('set_retryDelay', document.getElementById('set_retryDelay').value);
                    app.config.set('set_sysPrompt', document.getElementById('set_sysPrompt').value);
                    app.config.set('set_rulesPrompt', document.getElementById('set_rulesPrompt').value);
                    app.ui.closeSettings();
                    app.ui.checkKeys();
                    app.ui.log("Configuration Saved", "success");
                },
                log: (msg, type) => {
                    const el = document.getElementById('logConsole');
                    const div = document.createElement('div');
                    div.className = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : 'text-slate-400';
                    div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                    el.appendChild(div);
                    el.scrollTop = el.scrollHeight;
                },
                updateBatch: (i, status) => {
                    const el = document.getElementById(`batch-${i}`);
                    if (el) el.className = `h-2 w-full rounded-full transition-all ${status==='processing'?'bg-yellow-400 animate-pulse':status==='success'?'bg-green-500':status==='error'?'bg-red-500':'bg-slate-200'}`;
                }
            },

            core: {
                handleFile: async (f) => {
                    if (!f || f.type !== 'application/pdf') return alert('PDF Only');
                    app.state.file = f;
                    const cached = await app.db.check(f);
                    if(cached) {
                        document.getElementById('cacheDate').textContent = `Saved: ${cached.date.toLocaleString()}`;
                        document.getElementById('cacheModal').classList.remove('hidden');
                        app.state.cachedRecord = cached;
                        return;
                    }
                    app.core.loadUI(f);
                },
                processCache: (useCache) => {
                    document.getElementById('cacheModal').classList.add('hidden');
                    if(useCache) {
                        app.state.finalPDFBlob = app.state.cachedRecord.outputBlob;
                        document.getElementById('dropZone').classList.add('hidden');
                        document.getElementById('resultPanel').classList.remove('hidden');
                        app.ui.log('Loaded from Cache', 'success');
                    } else {
                        app.core.loadUI(app.state.file);
                    }
                },
                loadUI: (f) => {
                    document.getElementById('dropZone').classList.add('hidden');
                    document.getElementById('fileInfoPanel').classList.remove('hidden');
                    document.getElementById('fileName').textContent = f.name;
                    document.getElementById('fileSize').textContent = (f.size/1024/1024).toFixed(2) + " MB";
                },
                clearFile: () => location.reload(),
                startProcessing: async () => {
                    if (!['key_gemini','key_groq','key_cerebras'].some(k => app.config.get(k))) return app.ui.openSettings();

                    document.getElementById('fileInfoPanel').classList.add('hidden');
                    document.getElementById('progressPanel').classList.remove('hidden');

                    const concurrency = parseInt(app.config.get('set_concurrency') || 1);
                    document.getElementById('concurrencyIndicator').innerText = `Concurrency: ${concurrency}x`;

                    app.ui.log('Extracting Text...');
                    const text = await app.core.extractText(app.state.file);
                    app.state.chunks = app.core.chunk(text, 15000);

                    const container = document.getElementById('batchContainer');
                    container.innerHTML = '';
                    app.state.chunks.forEach((_, i) => {
                        const d = document.createElement('div');
                        d.id = `batch-${i}`; d.className = 'h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full';
                        container.appendChild(d);
                    });

                    app.state.results = new Array(app.state.chunks.length);

                    const limit = concurrency;
                    let index = 0;
                    const processNext = async () => {
                        if (index >= app.state.chunks.length) return;
                        const i = index++;
                        try {
                            await app.engine.process(app.state.chunks[i], i);
                            document.getElementById('totalProgressText').textContent = Math.round(((i+1)/app.state.chunks.length)*100) + '%';
                        } catch(e) { console.error(e); }
                        await processNext();
                    };
                    const pool = [];
                    for(let k=0; k<limit; k++) pool.push(processNext());
                    await Promise.all(pool);

                    app.core.finish();
                },
                extractText: async (f) => {
                    const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
                    let txt = "";
                    for(let i=1; i<=pdf.numPages; i++) txt += (await (await pdf.getPage(i)).getTextContent()).items.map(x=>x.str).join(' ') + "\n\n";
                    return txt;
                },
                chunk: (t, s) => {
                    const chunks = []; let cur = "";
                    t.split('\n').forEach(l => { if(cur.length + l.length > s) { chunks.push(cur); cur = l + "\n"; } else cur += l + "\n"; });
                    if(cur) chunks.push(cur);
                    return chunks;
                },
                finish: async () => {
                    const doc = new window.jspdf.jsPDF();
                    app.state.results.forEach(res => { if(res) app.core.renderMarkdownToPdf(doc, res); });
                    const pdfBlob = doc.output('blob');
                    app.state.finalPDFBlob = pdfBlob;
                    await app.db.save(app.state.file, pdfBlob);
                    document.getElementById('progressPanel').classList.add('hidden');
                    document.getElementById('resultPanel').classList.remove('hidden');
                },
                renderMarkdownToPdf: (doc, markdownText) => {
                    const tokens = marked.lexer(markdownText);
                    let y = 20, pageHeight = 280, margin = 20, maxWidth = 170;
                    const addText = (text, fontSize, fontStyle) => {
                        doc.setFontSize(fontSize); doc.setFont("times", fontStyle);
                        const cleanText = text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/#/g, '').replace(/`/g, '');
                        doc.splitTextToSize(cleanText, maxWidth).forEach(line => {
                            if (y > pageHeight) { doc.addPage(); y = margin; }
                            doc.text(line, margin, y); y += (fontSize * 0.4);
                        });
                        y += (fontSize * 0.2);
                    };
                    tokens.forEach(token => {
                        if (token.type === 'heading') { addText(token.text, 16, 'bold'); y += 2; }
                        else if (token.type === 'paragraph') { addText(token.text, 12, 'normal'); }
                        else if (token.type === 'list') { token.items.forEach(item => addText("• " + item.text, 12, 'normal')); }
                        else if (token.type === 'code') { addText(token.text, 11, 'italic'); }
                    });
                },
                downloadFinal: () => {
                    if(app.state.finalPDFBlob) {
                        const url = URL.createObjectURL(app.state.finalPDFBlob);
                        const a = document.createElement('a');
                        a.href = url; a.download = `spokable_${app.state.file.name}`;
                        document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    }
                }
            },

            engine: {
                process: async (text, idx) => {
                    app.ui.updateBatch(idx, 'processing');
                    const sys = app.config.get('set_sysPrompt') || app.defaults.sys;
                    const rules = app.config.get('set_rulesPrompt') || app.defaults.rules;

                    let attempts = [];

                    // 1. GEMINI STRATEGY
                    if(app.config.get('key_gemini')) {
                        const k = app.config.get('key_gemini');
                        const pref = app.config.get('pref_gemini_model') || app.models.gemini[0];
                        // Preferred first, then rest
                        [pref, ...app.models.gemini.filter(m => m !== pref)].forEach(m => attempts.push({p:'gemini', m, k}));
                    }

                    // 2. GROQ STRATEGY
                    if(app.config.get('key_groq')) {
                        const k = app.config.get('key_groq');
                        const pref = app.config.get('pref_groq_model') || app.models.groq[0];
                        [pref, ...app.models.groq.filter(m => m !== pref)].forEach(m => attempts.push({p:'groq', m, k}));
                    }

                    // 3. CEREBRAS STRATEGY
                    if(app.config.get('key_cerebras')) {
                        const k = app.config.get('key_cerebras');
                        const pref = app.config.get('pref_cerebras_model') || app.models.cerebras[0];
                        [pref, ...app.models.cerebras.filter(m => m !== pref)].forEach(m => attempts.push({p:'cerebras', m, k}));
                    }

                    for(const att of attempts) {
                        try {
                            if(att.p !== 'gemini') app.ui.updateBatch(idx, 'fallback');
                            document.getElementById('activeProvider').textContent = `${att.p}: ${att.m}`;

                            const pd = app.providers[att.p];
                            const res = await fetch(pd.url(att.m, att.k), {
                                method: 'POST', headers: pd.headers(att.k), body: JSON.stringify(pd.payload(sys, rules, text, att.m))
                            });

                            if(!res.ok) {
                                if([429, 503].includes(res.status)) { await new Promise(r=>setTimeout(r, 1500)); continue; } // Retry/Next on rate limit
                                throw new Error(res.status);
                            }

                            const data = await res.json();
                            const out = pd.extract(data);
                            if(!out) throw new Error("Empty");

                            app.state.results[idx] = out;
                            app.ui.updateBatch(idx, 'success');
                            app.ui.log(`Batch ${idx+1} OK via ${att.m}`, 'success');
                            return;
                        } catch(e) { /* Continue to next model */ }
                    }
                    app.ui.updateBatch(idx, 'error');
                    app.state.results[idx] = "[FAILED]";
                }
            }
        };
        window.addEventListener('DOMContentLoaded', app.ui.init);
    </script>
</body>
</html>